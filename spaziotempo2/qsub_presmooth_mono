#!/bin/bash

#PBS -S /bin/bash
#PBS -l select=1:ncpus=28,walltime=24:00:00
#PBS -j oe
#PBS -N fitted_presmooth_mono_par

FILENAME="src_vicini/main_presmooth_mono_k_par_fitted"
FILENAME_exe="src_vicini/main_presmooth_mono_k_par_fitted_1e62e5"

cd "${PBS_O_WORKDIR}"

# clean log
rm -f log_pmp_fitted_1e62e5.txt compile_pmp_fitted_1e62e5.txt
echo "cleaning log files..." >> log_pmp_fitted_1e62e5.txt

# init spack
echo "loading spack" >> log_pmp_fitted_1e62e5.txt
if [ ! -f "${HOME}/spack.sh" ]; then
    echo "spack configuration file not found" >> log_pmp_fitted_1e62e5.txt
    exit 1
fi
source "${HOME}/spack.sh" >> log_pmp_fitted_1e62e5.txt 2>&1

echo "loading fdapde_devel environment" >> log_pmp_fitted_1e62e5.txt
spack env activate fdapde_devel >> log_pmp_fitted_1e62e5.txt 2>&1

# check packages
EIGEN_LOC="$(spack location -i eigen)"
if [ -z "$EIGEN_LOC" ]; then
    echo "Eigen dependency not found" >> log_pmp_fitted_1e62e5.txt
    exit 1
fi
echo "Eigen library found at ${EIGEN_LOC}" >> log_pmp_fitted_1e62e5.txt

# compile
echo "compiling..." >> log_pmp_fitted_1e62e5.txt
g++ -o $FILENAME_exe $FILENAME.cpp \
    -I../fdaPDE-cpp \
    -I../fdaPDE-cpp/fdaPDE/core \
    -I"$EIGEN_LOC/include/eigen3" \
    -march=native -O2 -std=c++20 >> compile_pmp_fitted_1e62e5.txt 2>&1

# run
echo "launching executable..." >> log_pmp_fitted_1e62e5.txt
./$FILENAME_exe >> log_pmp_fitted_1e62e5.txt 2>&1
